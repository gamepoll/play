trial6-2-1

  <div id="content">
    <button id="btnExport" type="button" text="Export" > Export to Image
    <button id="btnUpdate" type="button" text="Export" > update to server
    <button id="btnExtract" type="button" text="Export" > Extract to Image
  
    </button>
<br>
    <button id="btnReset" type="button" text="Export" > Reset Queue </button>
    <h3>png</h3>
    <img id="png-export"></img>
    <h3>jpg</h3>
    <img id="jpg-export"></img>
    <h3>svg</h3>
    <img id="svg-export"></img>
  
  </div>  
	

<textarea id="datakk" rows="5" cols="40"></textarea>
<br />

-------------------------------------------------------------------------------

$('#button_2328').on('click', function() { $('#text1').val("2328"); });
$('#button_xp').on('click', function() { $('#text1').val("xpp"); });

  function iOSversion() {
		if (/iP(hone|od|ad)/.test(navigator.platform)) {
			// supports iOS 2.0 and later: <http://bit.ly/TJjs1V>
			var v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
			return [parseInt(v[1], 10), parseInt(v[2], 10), parseInt(v[3] || 0, 10)];
		}
	}

	ver = iOSversion(); 

    var s = document.createElement("script");
    s.type = "text/javascript";


  if (!ver) {
		$('#demo').html('This is NOT running iOS ' );
		s.src = "https://cdn.plot.ly/plotly-latest.min.js";
  } else if (ver[0]<=5) {
	  $('#demo').html('This is running iOS < 6' );
  } else {
	  $('#demo').html('This is running iOS > 6' );
	  s.src = "https://cdn.plot.ly/plotly-latest.min.js";
  };
    s.innerHTML = null;
    s.id = "map";
    document.getElementById("output").innerHTML = "";
    document.getElementById("output").appendChild(s);

// Manual Script
jQuery(function($) {
  setInterval(function() {
    var date = new Date(),
        time = date.toLocaleTimeString();
    $(".clock").html(time);
  }, 1000);
});

function myTrigger() {
	var d=new Date();
	dc=document.getElementById("dropdown_change")
	dc1=document.getElementById("dropdown_change1")
	
	$('#demo').html("Loading ....." + d.getHours() + ":" + d.getMinutes() );
 
//	$.get( "https://script.google.com/macros/s/AKfycbw_R11-s8IQPBJ87VDg2MKXQk627ztHSV0wQLGMc0YozIJ92A4/exec?action=get&mode=base", function( data ) {
// for file hhh
//	$.get( "https://script.google.com/macros/s/AKfycbx6cw5tgL5eshOX8lsrGLSpU3WGAz59BWmWFKxlnRb-DRWNp9Uh/exec?action=get&mode=base", function( data ) {
	$.get( "https://script.google.com/macros/s/AKfycbx6cw5tgL5eshOX8lsrGLSpU3WGAz59BWmWFKxlnRb-DRWNp9Uh/exec?action=get&mode=plot6&code="+$('#text1').val()+"&code1="+dc.value+"&code2="+dc1.value, function( data ) {	
	$('#demo').html(data + "@" + d.getHours() + ":" + d.getMinutes() );
            });
};

$("#dropdown").change(function(){
      dc=document.getElementById("dropdown")
		$("#text1").val(dc.value);
});

     $("#dropdown_change").change(function(){
dc=document.getElementById("dropdown_change")
//       alert("Selected value is : " + document.getElementById("dropdown_change").value);
       $("#text2").val(dc.value);
		     });

//$("#button_2388").on("click", function() { $("#text1").val("Bochk"); $("#text2").val("gsx$bochk");});
//$("#button_8008").on("click", function() { $("#text1").val("Sunv"); $("#text2").val("gsx$sunv");});
//$('#button_2018').on('click', function() { $('#text1').val("Aact"); $("#text2").val("gsx$aact");});
//$('#button_2382').on('click', function() { $('#text1').val("Suno"); $("#text2").val("gsx$suno");});
//$('#button_0285').on('click', function() { $('#text1').val("Byee"); $("#text2").val("gsx$sunv");});
$("#button_vb").on("click", function() { makeplot(); makeplot1(); });
$("#button_vt").on("click", function() { makeplot(); makeplot1(); });


function makeplot() {
	//var url2 = "https://spreadsheets.google.com/feeds/list/1NYOFCAHvMkyOxItQqqhFLvna-yXnMheQbuxVPMV43Dk/o7lhxur/public/values?alt=json"; 
	// for file hhh
	// var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/o7lhxur/public/values?alt=json"; 
	// hhh.Sheet6 -spreadsheets.google.com/feeds/worksheets/spreadsheetId/public/basic
	// fields - spreadsheets.google.com/feeds/list/spreadsheetId/oz0xn5d/public/values?alt=json
	var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/oz0xn5d/public/values?alt=json"; 
	//var foo = $("#text2").val();
	//dc=document.getElementById("dropdown_change")
	
	Plotly.d3.json(url2, function (error, result) { 
		var x = [], y = [], y2=[], y3=[]; 
		for (i = 0; i < result.feed.entry.length; i += 1) { 
			x.push(new Date(result.feed.entry[i].gsx$date_4.$t)); 
//			y.push(result.feed.entry[i].gsx$tsxbockhk.$t); 
// http://bl.ocks.org/tmaybe/6246014
//			y.push(result.feed.entry[i].gsx$v1.$t/result.feed.entry[i].gsx$yy1.$t); 
			y.push(result.feed.entry[i].gsx$v1.$t*result.feed.entry[i].gsx$yy1.$t); 
			y2.push(result.feed.entry[i].gsx$v1.$t); 
			y3.push(result.feed.entry[i].gsx$yy1.$t); 
		} ;
		var pu1 = [], pu2 = [];
		for (i = 0; i < result.feed.entry.length; i += 1) { 
			pu1.push(result.feed.entry[i].gsx$pullupname.$t); 
			pu2.push(result.feed.entry[i].gsx$pullupcode.$t); 
		};
		dc=document.getElementById("dropdown")

// Loop through the array
for (var i = 0; i < pu1.length; ++i) {
    // Append the element to the end of Array list
    dc[dc.length] = new Option(pu1[i], pu2[i]);
}
		//makePlotly2( x, y, y2, y3,"Tsx" + $("#text1").val(), "Tenc" + $("#text1").val(), $("#text1").val(),"myDiv1"); 
		makePlotly2( x, y, y2, y3,result.feed.entry[1].gsx$paraxx.$t + result.feed.entry[0].gsx$paraxx.$t, result.feed.entry[1].gsx$paraxx.$t+"", result.feed.entry[0].gsx$paraxx.$t,"myDiv1");
	}); 
}; 

function makePlotly2( x, y, y2, y3, yname, y2name, y3name, divname){
	var selectorOptions = {
    buttons: [{
        step: 'year',
        stepmode: 'backward',
        count: 2,
        label: '2y'
    }, {
        step: 'year',
        stepmode: 'backward',
        count: 4,
        label: '4y'
    }, {
        step: 'year',
        stepmode: 'backward',
        count: 6,
        label: '6y'
    }, {
        step: 'year',
        stepmode: 'backward',
        count: 8,
        label: '8y'
    }, {
        step: 'all',
    }],
};
	var traces = { x: x, y: y, name: yname, text: ['Text G', 'Text H', 'Text I']}; 
	var traces2 = { x: x, y: y2, name: y2name, 
						//mode: 'lines+markers', 
						marker: { color: 'rgb(128, 0, 128)', size: 5 }, 
						yaxis: 'y2',
		       				visible: 'legendonly'
					  }; console.log("y2=",y2);
	var traces3 = { x: x, y: y3, name: y3name, 
						mode: 'lines+markers+texts', text: 'sdf',
						marker: {  size: 5 }, 
						yaxis: 'y3' 
					  };
  //
  var arr = movingWindowAvg( y, 62 );
  var traces4 = { x: x, y: arr, name: "MA", 
						mode: 'lines+markers+texts', text:"fff",
						marker: {  size: 5 }, 
						yaxis: 'y4' 
					  };
  console.log("ttrace4=",traces4);
	var data = [traces, traces2, traces3, traces4]; 
	var layout = { title: yname, 
					  xaxis: {
            rangeselector: selectorOptions
 //           ,rangeslider: {}
        },
					  yaxis: {/*title: yname*/}, 
					  yaxis2: {// title: y2name, 

								  overlaying: 'y', side: 'left' } ,
					  yaxis3: {

								  overlaying: 'y', side: 'right' } ,

            yaxis4: {

								  overlaying: 'y', side: 'left' } 
					 }; 
  
layout.annotations = [{
  text: "Official "+y3[(y3.length)-1]+'<br>=>'+x[x.length-1].toLocaleDateString()+"<br>=>"+x[x.length-5].toLocaleTimeString(),
  x: x[x.length-1],
  y: y[(y.length)-5],
  xref: 'x',
  yref: 'y',
  showarrow: true,
  xanchor: 'left'}
];
  
layout.shapes = [{
  x0: x[x.length-1],
  x1: x[x.length-1],
  type: 'line',
  y0: 0,
  y1: 1,
  xref: 'x',
  yref: 'paper',
  line: {
    color: 'rgb(30,30,30)',
    width: 1
  }
}];

	Plotly.newPlot(divname, data, layout); Plotly.purge;
  	plot = document.getElementById('i'+divname).contentWindow;
        // send a message to the contentWindow
        plot.postMessage(
        {
            'task': 'newPlot',
            'data': data,
            'layout': layout
        },
        'https://plot.ly');
	average = false;
	
var plot, type;
var rad = document.myForm.rads;
var prev = null;

for(var i = 0; i < rad.length; i++) {
    rad[i].onclick = function() {
        (prev)? console.log(prev.value):null;
        if(this !== prev) { prev = this; }
        color = this.value;
	        plot = document.getElementById('imyDiv1').contentWindow;
        // send a message to the contentWindow
        plot.postMessage(
        {
            'task': 'restyle',
            'update': {'marker':{'color': color}},
            'indices': [0]
        },
        'https://plot.ly');
    };
}
  
}; 

function makeplot1() {
	//var url2 = "https://spreadsheets.google.com/feeds/list/1NYOFCAHvMkyOxItQqqhFLvna-yXnMheQbuxVPMV43Dk/o7lhxur/public/values?alt=json"; 
	// for file hhh
	// var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/o7lhxur/public/values?alt=json"; 
	// hhh.Sheet6 -spreadsheets.google.com/feeds/worksheets/spreadsheetId/public/basic
	// fields - spreadsheets.google.com/feeds/list/spreadsheetId/oz0xn5d/public/values?alt=json
	var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/oz0xn5d/public/values?alt=json"; 
	//var foo = $("#text2").val();
	//dc=document.getElementById("dropdown_change")
	
	Plotly.d3.json(url2, function (error, result) { 
		var x = [], y = [], y2=[], y3=[]; 
		for (i = 0; i < result.feed.entry.length; i += 1) { 
			x.push(new Date(result.feed.entry[i].gsx$date_5.$t)); 
//			y.push(result.feed.entry[i].gsx$tsxbockhk.$t); 
// http://bl.ocks.org/tmaybe/6246014
//			y.push(result.feed.entry[i].gsx$v2.$t/result.feed.entry[i].gsx$yy.$t); 
			y.push(result.feed.entry[i].gsx$v2.$t*result.feed.entry[i].gsx$yy.$t); 
			y2.push(result.feed.entry[i].gsx$v2.$t); 
			y3.push(result.feed.entry[i].gsx$yy.$t); 
		} 
		//makePlotly2( x, y, y2, y3,"Tsx" + $("#text1").val(), "Tenc" + $("#text1").val(), $("#text1").val(),"myDiv1"); 
		makePlotly2( x, y, y2, y3,result.feed.entry[2].gsx$paraxx.$t + result.feed.entry[0].gsx$paraxx.$t, result.feed.entry[2].gsx$paraxx.$t+"", result.feed.entry[0].gsx$paraxx.$t,"myDiv2");
	}); 
}; 



makeplot();
makeplot1();

// Made with Plotly's postMessage API
// https://github.com/plotly/postMessage-API

var average = false;
var plot = document.getElementById('imyDiv1').contentWindow;
var X, Y, vis;

var d3_numeric = function(x) {
 	return !isNaN(x);
}

var d3sum = function(array, f) {
  var s = 0,
      n = array.length,
      a,
      i = -1;
  if (arguments.length === 1) {
	 // zero and null are equivalent
    while (++i < n) if (d3_numeric(a = +array[i])) s += a; 
  } else {
    while (++i < n) if (d3_numeric(a = +f.call(array, array[i], i))) s += a;
  }
  return s;
};

var movingWindowAvg = function (arr, step) {  
    return arr.map(function (_, idx) { 
        var wnd = arr.slice(idx - step, idx + step + 1); 
        var result = d3sum(wnd) / wnd.length; if (isNaN(result)) { result = _; }
        return result; 
    });
};

function applyAvg(index){
	// get current x, y data
	if( index===undefined ){ 
		index=0;
	}
	index=index.toString();
	plot.postMessage({
		 task: 'getAttributes',
		 attributes: [ 'data['+index+'].x', 'data['+index+'].y' ] },
		 'https://plot.ly/');   
}

window.addEventListener('message', function(e) {
		
	var message = e.data;

	if( 'data[3].visible' in message.response ){
		var vis = message.response['data[3].visible'];
		console.log('Average visible', vis);
		if( vis === undefined ){
				plot.postMessage({
		 			task: 'getAttributes',
		 			attributes: [ 'data[0].x', 'data[0].y' ] },
		 			'https://plot.ly/');
		}
		else if( vis == true ){
			vis = false;	
		}
		else{
			vis = true;
		}
		
		plot.postMessage({
			task: 'restyle',
			update: { 'visible':vis },
			indices: [3]
		}, 'https://plot.ly'); 
	}
	else{
		var window = document.getElementById('myRange').value;
		$("#valrg").html(window);
		X = message.response['data[0].x'];
		Y = message.response['data[0].y'];	
		if( average ){
			var arr = movingWindowAvg( Y, Number(window) );		
			console.log('Recalculated average', arr);
			plot.postMessage({
				task: 'restyle',
				update: { y: [arr], x: [X], 'visible':true },
				indices: [3]
			}, 'https://plot.ly');  
		}
		else{		
			avg = { y: [arr], x: [X], visible:true, 
					 mode:'line', marker:{color:'#444'} };
			console.log( 'Adding moving average', avg );
			plot.postMessage({
				task: 'addTraces',
				traces: [ avg ],
				newIndices: [3]
			}, 'https://plot.ly'); 	
			applyAvg();
			average = true;
		}
	}
});

function toggleAvg(){
	// get current x, y data
	plot.postMessage({
		 task: 'getAttributes',
		 attributes: [ 'data[3].visible' ] },
		 'https://plot.ly/');
};


var img_png = d3.select('#png-export');
var img_svg = d3.select('#svg-export');

$('#btnExport').click(function(){  
  Plotly.toImage('myDiv2', { format: 'png', width: 800, height: 600 }).then(function (dataURL) {
        // console.log(dataURL);
        img_png.attr("src", dataURL);
    });
});


  //Local Storage JSON Array Example
  //codepen.io/jasongutt/pen/oDkdq
$('#btnUpdate').click(function(){ 

            $.getJSON("https://api.myjson.com/bins/x6qdy", function(posts) { 	
              
              // posts => LS
              localStorage.setItem("lsposts",JSON.stringify(posts));
              
              // LS => jsonArray
              jsonArray2 = JSON.parse(localStorage.getItem("lsposts"));
              
              // jsonArray2 += newjson
              jsonArray2.queue.push({
                key: "1088",
                key2: img_png.attr("src")
              });
              
              // do update
              $.ajax({
                url: "https://api.myjson.com/bins/x6qdy",
                type: "PUT",
                data: JSON.stringify(jsonArray2),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var json = JSON.stringify(data);
                    $("#datakk").val(json);
                }
              });

 						});
    });

$('#btnExtract').click(function(){  

            $.getJSON("https://api.myjson.com/bins/x6qdy", function(posts) { 															
                    console.log("pp2=",posts.queue[2].key2); 
                    
                    img_svg.attr("src", posts.queue[2].key2);

 						});
    });

$('#btnReset').click(function(){  

            var updatedObj = {
              queue: 
              [
                {key: "1088", name:"Banana"},
                {key: "1099", name:"Orange"}
              ]
            };
            var updatedData = JSON.stringify(updatedObj);

            // do update
            $.ajax({
                url: "https://api.myjson.com/bins/x6qdy",
                type: "PUT",
                data: updatedData,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var json = JSON.stringify(data);
                    $("#datakk").val(json);
                }
            });
    });




------------------------------------------------------------------------------------------------------------------
trial6-2-1

var img_png = d3.select('#png-export');
var img_svg = d3.select('#svg-export');

$('#btnExport').click(function(){  
  Plotly.toImage('myDiv2', { format: 'png', width: 800, height: 600 }).then(function (dataURL) {
        console.log(dataURL);
        img_png.attr("src", dataURL);
    });
});

$('#btnUpdate').click(function(){  
  
            $.getJSON("https://api.myjson.com/bins/x6qdy", function(posts) { 	
              // posts => LS
              //localStorage.setItem("lsposts",JSON.stringify(posts));
              // LS => jsonArray
              //jsonArray = new Array(JSON.parse(localStorage.getItem("lsposts")));
              jsonArray = new Array(JSON.stringify(posts));
              console.log("ww=",jsonArray);
              var newjson = img_png.attr("src");
              // jsonArray += newjson
              jsonArray.push({
                "key": "1088",
                "key2": newjson
              });
              console.log("pp2=",jsonArray); 
              
            // do update
            $.ajax({
                url: "https://api.myjson.com/bins/x6qdy",
                type: "PUT",
                data: JSON.stringify(jsonArray),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var json = JSON.stringify(data);
                    $("#datakk").val(json);
                }
            });
              // jsonArray => LS
              //localStorage.setItem("lsposts",JSON.stringify(jsonArray));
              // LS => server
              //var updatedData = JSON.stringify(lsposts);
              
              
             // console.log("pp2=",posts.key2); 
                    
             //       img_svg.attr("src", posts.key2);

 						});
   /*         var newjson = img_png.attr("src");
  
            var updatedObj = {
                "key": "1088",
                "key2": newjson
            };
            var updatedData = JSON.stringify(updatedObj);

            // do update
            $.ajax({
                url: "https://api.myjson.com/bins/x6qdy",
                type: "PUT",
                data: updatedData,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var json = JSON.stringify(data);
                    $("#datakk").val(json);
                }
            });
*/
    });

$('#btnExtract').click(function(){  

            $.getJSON("https://api.myjson.com/bins/x6qdy", function(posts) { 															
                    console.log("pp2=",posts[1].key2); 
                    
                    img_svg.attr("src", posts[1].key2);

 						});
    });


------------------------------------------------------------------------------------------------------------------------
trial6-2-1

$('#button_2328').on('click', function() { $('#text1').val("2328"); });
$('#button_xp').on('click', function() { $('#text1').val("xpp"); });

  function iOSversion() {
		if (/iP(hone|od|ad)/.test(navigator.platform)) {
			// supports iOS 2.0 and later: <http://bit.ly/TJjs1V>
			var v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
			return [parseInt(v[1], 10), parseInt(v[2], 10), parseInt(v[3] || 0, 10)];
		}
	}

	ver = iOSversion(); 

    var s = document.createElement("script");
    s.type = "text/javascript";


  if (!ver) {
		$('#demo').html('This is NOT running iOS ' );
		s.src = "https://cdn.plot.ly/plotly-latest.min.js";
  } else if (ver[0]<=5) {
	  $('#demo').html('This is running iOS < 6' );
  } else {
	  $('#demo').html('This is running iOS > 6' );
	  s.src = "https://cdn.plot.ly/plotly-latest.min.js";
  };
    s.innerHTML = null;
    s.id = "map";
    document.getElementById("output").innerHTML = "";
    document.getElementById("output").appendChild(s);

// Manual Script
jQuery(function($) {
  setInterval(function() {
    var date = new Date(),
        time = date.toLocaleTimeString();
    $(".clock").html(time);
  }, 1000);
});

function myTrigger() {
	var d=new Date();
	dc=document.getElementById("dropdown_change")
	dc1=document.getElementById("dropdown_change1")
	
	$('#demo').html("Loading ....." + d.getHours() + ":" + d.getMinutes() );
 
//	$.get( "https://script.google.com/macros/s/AKfycbw_R11-s8IQPBJ87VDg2MKXQk627ztHSV0wQLGMc0YozIJ92A4/exec?action=get&mode=base", function( data ) {
// for file hhh
//	$.get( "https://script.google.com/macros/s/AKfycbx6cw5tgL5eshOX8lsrGLSpU3WGAz59BWmWFKxlnRb-DRWNp9Uh/exec?action=get&mode=base", function( data ) {
	$.get( "https://script.google.com/macros/s/AKfycbx6cw5tgL5eshOX8lsrGLSpU3WGAz59BWmWFKxlnRb-DRWNp9Uh/exec?action=get&mode=plot6&code="+$('#text1').val()+"&code1="+dc.value+"&code2="+dc1.value, function( data ) {	
	$('#demo').html(data + "@" + d.getHours() + ":" + d.getMinutes() );
            });
};

$("#dropdown").change(function(){
      dc=document.getElementById("dropdown")
		$("#text1").val(dc.value);
});

     $("#dropdown_change").change(function(){
dc=document.getElementById("dropdown_change")
//       alert("Selected value is : " + document.getElementById("dropdown_change").value);
       $("#text2").val(dc.value);
		     });

//$("#button_2388").on("click", function() { $("#text1").val("Bochk"); $("#text2").val("gsx$bochk");});
//$("#button_8008").on("click", function() { $("#text1").val("Sunv"); $("#text2").val("gsx$sunv");});
//$('#button_2018').on('click', function() { $('#text1').val("Aact"); $("#text2").val("gsx$aact");});
//$('#button_2382').on('click', function() { $('#text1').val("Suno"); $("#text2").val("gsx$suno");});
//$('#button_0285').on('click', function() { $('#text1').val("Byee"); $("#text2").val("gsx$sunv");});
$("#button_vb").on("click", function() { makeplot(); makeplot1(); });
$("#button_vt").on("click", function() { makeplot(); makeplot1(); });


function makeplot() {
	//var url2 = "https://spreadsheets.google.com/feeds/list/1NYOFCAHvMkyOxItQqqhFLvna-yXnMheQbuxVPMV43Dk/o7lhxur/public/values?alt=json"; 
	// for file hhh
	// var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/o7lhxur/public/values?alt=json"; 
	// hhh.Sheet6 -spreadsheets.google.com/feeds/worksheets/spreadsheetId/public/basic
	// fields - spreadsheets.google.com/feeds/list/spreadsheetId/oz0xn5d/public/values?alt=json
	var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/oz0xn5d/public/values?alt=json"; 
	//var foo = $("#text2").val();
	//dc=document.getElementById("dropdown_change")
	
	Plotly.d3.json(url2, function (error, result) { 
		var x = [], y = [], y2=[], y3=[]; 
		for (i = 0; i < result.feed.entry.length; i += 1) { 
			x.push(new Date(result.feed.entry[i].gsx$date_4.$t)); 
//			y.push(result.feed.entry[i].gsx$tsxbockhk.$t); 
// http://bl.ocks.org/tmaybe/6246014
//			y.push(result.feed.entry[i].gsx$v1.$t/result.feed.entry[i].gsx$yy1.$t); 
			y.push(result.feed.entry[i].gsx$v1.$t*result.feed.entry[i].gsx$yy1.$t); 
			y2.push(result.feed.entry[i].gsx$v1.$t); 
			y3.push(result.feed.entry[i].gsx$yy1.$t); 
		} ;
		var pu1 = [], pu2 = [];
		for (i = 0; i < result.feed.entry.length; i += 1) { 
			pu1.push(result.feed.entry[i].gsx$pullupname.$t); 
			pu2.push(result.feed.entry[i].gsx$pullupcode.$t); 
		};
		dc=document.getElementById("dropdown")

// Loop through the array
for (var i = 0; i < pu1.length; ++i) {
    // Append the element to the end of Array list
    dc[dc.length] = new Option(pu1[i], pu2[i]);
}
		//makePlotly2( x, y, y2, y3,"Tsx" + $("#text1").val(), "Tenc" + $("#text1").val(), $("#text1").val(),"myDiv1"); 
		makePlotly2( x, y, y2, y3,result.feed.entry[1].gsx$paraxx.$t + result.feed.entry[0].gsx$paraxx.$t, result.feed.entry[1].gsx$paraxx.$t+"", result.feed.entry[0].gsx$paraxx.$t,"myDiv1");
	}); 
}; 

function makePlotly2( x, y, y2, y3, yname, y2name, y3name, divname){
	var selectorOptions = {
    buttons: [{
        step: 'year',
        stepmode: 'backward',
        count: 2,
        label: '2y'
    }, {
        step: 'year',
        stepmode: 'backward',
        count: 4,
        label: '4y'
    }, {
        step: 'year',
        stepmode: 'backward',
        count: 6,
        label: '6y'
    }, {
        step: 'year',
        stepmode: 'backward',
        count: 8,
        label: '8y'
    }, {
        step: 'all',
    }],
};
	var traces = { x: x, y: y, name: yname, text: ['Text G', 'Text H', 'Text I']}; 
	var traces2 = { x: x, y: y2, name: y2name, 
						//mode: 'lines+markers', 
						marker: { color: 'rgb(128, 0, 128)', size: 5 }, 
						yaxis: 'y2',
		       				visible: 'legendonly'
					  }; console.log("y2=",y2);
	var traces3 = { x: x, y: y3, name: y3name, 
						mode: 'lines+markers+texts', text: 'sdf',
						marker: {  size: 5 }, 
						yaxis: 'y3' 
					  };
  //
  var arr = movingWindowAvg( y, 62 );
  var traces4 = { x: x, y: arr, name: "MA", 
						mode: 'lines+markers+texts', text:"fff",
						marker: {  size: 5 }, 
						yaxis: 'y4' 
					  };
  console.log("ttrace4=",traces4);
	var data = [traces, traces2, traces3, traces4]; 
	var layout = { title: yname, 
					  xaxis: {
            rangeselector: selectorOptions
 //           ,rangeslider: {}
        },
					  yaxis: {/*title: yname*/}, 
					  yaxis2: {// title: y2name, 

								  overlaying: 'y', side: 'left' } ,
					  yaxis3: {

								  overlaying: 'y', side: 'right' } ,

            yaxis4: {

								  overlaying: 'y', side: 'left' } 
					 }; 
  
layout.annotations = [{
  text: "Official "+y3[(y3.length)-1]+'<br>=>'+x[x.length-1].toLocaleDateString()+"<br>=>"+x[x.length-5].toLocaleTimeString(),
  x: x[x.length-1],
  y: y[(y.length)-5],
  xref: 'x',
  yref: 'y',
  showarrow: true,
  xanchor: 'left'}
];
  
layout.shapes = [{
  x0: x[x.length-1],
  x1: x[x.length-1],
  type: 'line',
  y0: 0,
  y1: 1,
  xref: 'x',
  yref: 'paper',
  line: {
    color: 'rgb(30,30,30)',
    width: 1
  }
}];

	Plotly.newPlot(divname, data, layout); Plotly.purge;
  	plot = document.getElementById('i'+divname).contentWindow;
        // send a message to the contentWindow
        plot.postMessage(
        {
            'task': 'newPlot',
            'data': data,
            'layout': layout
        },
        'https://plot.ly');
	average = false;
	
var plot, type;
var rad = document.myForm.rads;
var prev = null;

for(var i = 0; i < rad.length; i++) {
    rad[i].onclick = function() {
        (prev)? console.log(prev.value):null;
        if(this !== prev) { prev = this; }
        color = this.value;
	        plot = document.getElementById('imyDiv1').contentWindow;
        // send a message to the contentWindow
        plot.postMessage(
        {
            'task': 'restyle',
            'update': {'marker':{'color': color}},
            'indices': [0]
        },
        'https://plot.ly');
    };
}
  
}; 

function makeplot1() {
	//var url2 = "https://spreadsheets.google.com/feeds/list/1NYOFCAHvMkyOxItQqqhFLvna-yXnMheQbuxVPMV43Dk/o7lhxur/public/values?alt=json"; 
	// for file hhh
	// var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/o7lhxur/public/values?alt=json"; 
	// hhh.Sheet6 -spreadsheets.google.com/feeds/worksheets/spreadsheetId/public/basic
	// fields - spreadsheets.google.com/feeds/list/spreadsheetId/oz0xn5d/public/values?alt=json
	var url2 = "https://spreadsheets.google.com/feeds/list/1bn8v2viL4MM7uQpS0iKquWvtH6qt1QMaSRK2WpvbON4/oz0xn5d/public/values?alt=json"; 
	//var foo = $("#text2").val();
	//dc=document.getElementById("dropdown_change")
	
	Plotly.d3.json(url2, function (error, result) { 
		var x = [], y = [], y2=[], y3=[]; 
		for (i = 0; i < result.feed.entry.length; i += 1) { 
			x.push(new Date(result.feed.entry[i].gsx$date_5.$t)); 
//			y.push(result.feed.entry[i].gsx$tsxbockhk.$t); 
// http://bl.ocks.org/tmaybe/6246014
//			y.push(result.feed.entry[i].gsx$v2.$t/result.feed.entry[i].gsx$yy.$t); 
			y.push(result.feed.entry[i].gsx$v2.$t*result.feed.entry[i].gsx$yy.$t); 
			y2.push(result.feed.entry[i].gsx$v2.$t); 
			y3.push(result.feed.entry[i].gsx$yy.$t); 
		} 
		//makePlotly2( x, y, y2, y3,"Tsx" + $("#text1").val(), "Tenc" + $("#text1").val(), $("#text1").val(),"myDiv1"); 
		makePlotly2( x, y, y2, y3,result.feed.entry[2].gsx$paraxx.$t + result.feed.entry[0].gsx$paraxx.$t, result.feed.entry[2].gsx$paraxx.$t+"", result.feed.entry[0].gsx$paraxx.$t,"myDiv2");
	}); 
}; 



makeplot();
makeplot1();

// Made with Plotly's postMessage API
// https://github.com/plotly/postMessage-API

var average = false;
var plot = document.getElementById('imyDiv1').contentWindow;
var X, Y, vis;

var d3_numeric = function(x) {
 	return !isNaN(x);
}

var d3sum = function(array, f) {
  var s = 0,
      n = array.length,
      a,
      i = -1;
  if (arguments.length === 1) {
	 // zero and null are equivalent
    while (++i < n) if (d3_numeric(a = +array[i])) s += a; 
  } else {
    while (++i < n) if (d3_numeric(a = +f.call(array, array[i], i))) s += a;
  }
  return s;
};

var movingWindowAvg = function (arr, step) {  
    return arr.map(function (_, idx) { 
        var wnd = arr.slice(idx - step, idx + step + 1); 
        var result = d3sum(wnd) / wnd.length; if (isNaN(result)) { result = _; }
        return result; 
    });
};

function applyAvg(index){
	// get current x, y data
	if( index===undefined ){ 
		index=0;
	}
	index=index.toString();
	plot.postMessage({
		 task: 'getAttributes',
		 attributes: [ 'data['+index+'].x', 'data['+index+'].y' ] },
		 'https://plot.ly/');   
}

window.addEventListener('message', function(e) {
		
	var message = e.data;

	if( 'data[3].visible' in message.response ){
		var vis = message.response['data[3].visible'];
		console.log('Average visible', vis);
		if( vis === undefined ){
				plot.postMessage({
		 			task: 'getAttributes',
		 			attributes: [ 'data[0].x', 'data[0].y' ] },
		 			'https://plot.ly/');
		}
		else if( vis == true ){
			vis = false;	
		}
		else{
			vis = true;
		}
		
		plot.postMessage({
			task: 'restyle',
			update: { 'visible':vis },
			indices: [3]
		}, 'https://plot.ly'); 
	}
	else{
		var window = document.getElementById('myRange').value;
		$("#valrg").html(window);
		X = message.response['data[0].x'];
		Y = message.response['data[0].y'];	
		if( average ){
			var arr = movingWindowAvg( Y, Number(window) );		
			console.log('Recalculated average', arr);
			plot.postMessage({
				task: 'restyle',
				update: { y: [arr], x: [X], 'visible':true },
				indices: [3]
			}, 'https://plot.ly');  
		}
		else{		
			avg = { y: [arr], x: [X], visible:true, 
					 mode:'line', marker:{color:'#444'} };
			console.log( 'Adding moving average', avg );
			plot.postMessage({
				task: 'addTraces',
				traces: [ avg ],
				newIndices: [3]
			}, 'https://plot.ly'); 	
			applyAvg();
			average = true;
		}
	}
});

function toggleAvg(){
	// get current x, y data
	plot.postMessage({
		 task: 'getAttributes',
		 attributes: [ 'data[3].visible' ] },
		 'https://plot.ly/');
};

var img_png = d3.select('#png-export');
var img_svg = d3.select('#svg-export');

$('#btnExport').click(function(){  
  Plotly.toImage('myDiv2', { format: 'png', width: 800, height: 600 }).then(function (dataURL) {
        console.log(dataURL);
        img_png.attr("src", dataURL);
    });
});

$('#btnUpdate').click(function(){  

            var newjson = img_png.attr("src");
  
            var updatedObj = {
                "key": "1088",
                "key2": newjson
            };
            var updatedData = JSON.stringify(updatedObj);

            // do update
            $.ajax({
                url: "https://api.myjson.com/bins/x6qdy",
                type: "PUT",
                data: updatedData,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var json = JSON.stringify(data);
                    $("#datakk").val(json);
                }
            });

    });

$('#btnExtract').click(function(){  

            $.getJSON("https://api.myjson.com/bins/x6qdy", function(posts) { 															
                    console.log("pp2=",posts.key2); 
                    
                    img_svg.attr("src", posts.key2);

 						});
    });








-------------------------------------------------------------------------------
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Slim 2dy - js by gamepoll135</title>
<!-- Floating Menu -->

<!-- Include jQuery -->

  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<script>
	
$('#sector_front').on('click', 'button', function () {
document.getElementById('imgbb').src="https://www.kitconet.com/charts/metals/silver/t24_ag_en_usoz_4.gif?p=8&k=" + Math.floor(Math.random() * (100 + 1) + 0);
	
 	document.getElementById('img_sf_a_m').src="http://charts.megahubhk.com/servlets/MHImageChart?sid=02333&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_a_aa').src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=02333&amp;type=4&amp;period=0&amp;width=300&amp;height=130&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_b_m').src="http://charts.megahubhk.com/servlets/MHImageChart?sid=01099&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_b_aa').src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=01099&amp;type=4&amp;period=0&amp;width=300&amp;height=130&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_c_m').src="http://charts.megahubhk.com/servlets/MHImageChart?sid=01193&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_c_aa').src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=01193&amp;type=4&amp;period=0&amp;width=300&amp;height=130&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_d_m').src="http://charts.megahubhk.com/servlets/MHImageChart?sid=0941&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_d_aa').src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=0941&amp;type=4&amp;period=0&amp;width=300&amp;height=130&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_e_m').src="http://charts.megahubhk.com/servlets/MHImageChart?sid=02688&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_e_aa').src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=02688&amp;type=4&amp;period=0&amp;width=300&amp;height=130&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_f_m').src="http://charts.megahubhk.com/servlets/MHImageChart?sid=01833&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_f_aa').src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=01833&amp;type=4&amp;period=0&amp;width=300&amp;height=130&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_g_m').src="http://charts.megahubhk.com/servlets/MHImageChart?sid=03046&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 	document.getElementById('img_sf_g_aa').src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=03046&amp;type=4&amp;period=0&amp;width=300&amp;height=130&p=" + Math.floor(Math.random() * (100 + 1) + 0);
 
});

	
	
</script>

<style type='text/css'>
/*
body {
   background-color: #333;  
   color: #999;
   font: 12px/1.4em Arial,sans-serif;
}
#wrap {
   margin: 10px auto;        
   background: #666;
   padding: 10px;
   width: 700px;
}
#header {
   background-color: #666;
   color: #FFF;
}
#logo {
   font-size: 30px;  
   line-height: 40px;    
   padding: 5px;
}
*/
#navWrap {
   height: 30px;
}
/*Background*/
#nav {
   padding: 5px;
background-color:rgba(7,7,7,0.1);
/*   background: transparent;    */
}
#nav ul {
   margin: 0;
   padding: 0;    
}
/*Menu Items*/
#nav li {
   float: left;
   padding: 3px 8px;
   background-color: #FFF;
   margin: 0 10px 0 0;
   color: #F00;
   list-style-type: none;
background-color: transparent;
}
/*
#nav li a {
   color: #F00;  
   text-decoration: none;    
}
#nav li a:hover {
   text-decoration: underline;   
}
*/
br.clearLeft {
   clear: left;        
}


</style>





<html>

<br>

<div id="sector_front">	
	<button>Click Mee</button>

<br />

<img id="imgbb" src="https://www.kitconet.com/charts/metals/silver/t24_ag_en_usoz_4.gif?p=8"  alt="Kenny g Breathless" width="440" height="400" border="0">	      
		      
<br />

<img id="img_sf_a_m" src="http://charts.megahubhk.com/servlets/MHImageChart?sid=02333&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&.gif" alt="Kenny g Breathless" height="390" width="430" border="0">
<img id="img_sf_a_aa" src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=02333&amp;type=4&amp;period=0&amp;width=300&amp;height=130&amp;scheme=1" alt="Kenny g Breathless" height="390" width="430" border="0">
<br>
　　溢利增長(%)26
<br>

<img id="img_mon_b_m" src="http://charts.megahubhk.com/servlets/MHImageChart?sid=01099&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&.gif" alt="Kenny g Breathless" height="390" width="430" border="0">
<img id="img_mon_b_aa" src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=01099&amp;type=4&amp;period=0&amp;width=300&amp;height=130&amp;scheme=1" alt="Kenny g Breathless" height="390" width="430" border="0">
<br>
　　溢利增長(%)22
<br>
<br>
  公佈(Mar)
<br/>股息(Jun)人民幣 0.57
<br/>  8 ----- 10
<br/>  45 ----- 57
<br>
2018/07/04    股息：人民幣 0.57
<br>
2016    股息：人民幣 0.50
<br>
2015    股息：人民幣 0.31
<br>
2014    股息：人民幣 0.26
<br>
2013    股息：人民幣 0.25
<br>
2012    股息：人民幣 0.19
<br>
2011	股息：人民幣 0.16
<br>
2010	股息：人民幣 0.0101
<br>
<br>
<img id="img_mon_c_m" src="http://charts.megahubhk.com/servlets/MHImageChart?sid=01193&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&.gif" alt="Kenny g Breathless" height="390" width="430" border="0">
<img id="img_mon_c_aa" src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=01193&amp;type=4&amp;period=0&amp;width=300&amp;height=130&amp;scheme=1" alt="Kenny g Breathless" height="390" width="430" border="0">
<br>
　　溢利增長(%)45
<br>


<img id="img_mon_d_m" src="http://charts.megahubhk.com/servlets/MHImageChart?sid=0941&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&" alt="Kenny g Breathless" height="390" width="430" border="0">
<img id="img_mon_d_aa" src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=0941&amp;type=4&amp;period=0&amp;width=300&amp;height=130&amp;scheme=1" alt="Kenny g Breathless" height="390" width="430" border="0">
<br>
　　溢利增長(%)8
<br>

<br />	
	<button>Click Me</button>
<br />


<img id="img_mon_e_m" src="http://charts.megahubhk.com/servlets/MHImageChart?sid=02688&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&" alt="Kenny g Breathless" height="390" width="430" border="0">
<img id="img_mon_e_aa" src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=02688&amp;type=4&amp;period=0&amp;width=300&amp;height=130&amp;scheme=1" alt="Kenny g Breathless" height="390" width="430" border="0">
<br>
　　溢利增長(%)20
<br>

<img id="img_mon_f_m" src="http://charts.megahubhk.com/servlets/MHImageChart?sid=01833&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&" alt="Kenny g Breathless" height="390" width="430" border="0">
<img id="img_mon_f_aa" src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=01833&amp;type=4&amp;period=0&amp;width=300&amp;height=130&amp;scheme=1" alt="Kenny g Breathless" height="390" width="430" border="0">
<br>
　　溢利增長(%)10
<br>

<br />	
	<button>Click Me</button>
<br />


<img id="img_mon_g_m" src="http://charts.megahubhk.com/servlets/MHImageChart?sid=03046&mChart2=11&m2p1=7&cmode=1&vol=1&intTech1=1&it1p1=50&it1p5=200&tstyle=2&fsize=10&&cr=106&cwidth=499&cheight=375&lang=1&cperiod=1010300&ctype=1&wm=13&" alt="Kenny g Breathless" height="390" width="430" border="0">
<img id="img_mon_g_aa" src="http://charts.aastocks.com/servlet/Charts?com=1&amp;stockid=03046&amp;type=4&amp;period=0&amp;width=300&amp;height=130&amp;scheme=1" alt="Kenny g Breathless" height="390" width="430" border="0">
<br>
　　股息mean5yr(DEC)$1.7
<br/>  2 ----- 3
<br/>  34 ----- 51
<br>
2018/12/02    股息：港元 2.0100
<br>
2017/12/02    股息：港元 1.4800
<br>
2016/12/02    股息：港元 1.3800
<br>
2015/12/02    股息：港元 1.5900
<br>
2014/12/02    股息：港元 2.1700
<br>
2013/12/02    股息：港元 1.4100 
<br>
2012/11/20    股息：港元 1.4500
<br>
2011/11/18	股息：港元 1.1300
<br>
2010/11/19	股息：港元 1.3300
<br>
</div>

